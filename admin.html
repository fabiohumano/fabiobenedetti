
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cérebro | Fabio Benedetti Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background-color: #080808; color: white; font-family: 'Inter', sans-serif; }
        .input-dark { background: #121212; border: 1px solid #222; padding: 16px; border-radius: 12px; width: 100%; color: white; outline: none; transition: all 0.3s; }
        .input-dark:focus { border-color: #444; background: #181818; }
        .btn-primary { background: white; color: black; font-weight: bold; padding: 16px; border-radius: 12px; transition: all 0.3s; cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em; font-size: 11px; }
        .btn-primary:hover { background: #eee; transform: translateY(-2px); }
        .tab-btn { color: #444; transition: all 0.3s; padding: 12px 0; font-size: 10px; font-weight: bold; letter-spacing: 0.25em; border-bottom: 2px solid transparent; text-transform: uppercase; }
        .tab-btn.active { color: white; border-color: white; }
        .hidden { display: none; }
        .live-reference { background: rgba(255,255,255,0.02); border-left: 2px solid #333; padding: 12px 16px; margin-bottom: 12px; font-size: 11px; color: #666; border-radius: 4px; white-space: pre-wrap; }
        .progress-bar { height: 4px; background: #222; border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .progress-inner { height: 100%; background: white; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body class="p-6 md:p-12">

    <div id="login-screen" class="max-w-md mx-auto mt-24 p-12 bg-neutral-900/50 rounded-[3rem] border border-white/5 backdrop-blur-xl">
        <h1 class="text-2xl font-bold mb-10 text-center tracking-tighter italic">FABIO <span class="text-neutral-600 font-light">Cérebro</span></h1>
        <form id="login-form" class="space-y-4">
            <input type="email" id="login-email" placeholder="E-mail" class="input-dark" required>
            <input type="password" id="login-pass" placeholder="Senha" class="input-dark" required>
            <button type="submit" class="w-full btn-primary">Entrar</button>
        </form>
    </div>

    <div id="admin-dashboard" class="max-w-6xl mx-auto hidden">
        <div class="flex justify-between items-center mb-16 border-b border-white/5 pb-10">
            <h1 class="text-xs font-bold tracking-[0.5em] uppercase">Controle de Sistema <span class="text-neutral-700 italic lowercase ml-2">fabiobenedetti.com.br</span></h1>
            <button id="logout-btn" class="text-[9px] text-neutral-600 hover:text-red-500 uppercase tracking-widest font-bold">Encerrar Sessão</button>
        </div>

        <div class="flex space-x-12 mb-20 border-b border-white/5 overflow-x-auto">
            <button onclick="switchTab('home-vids')" id="tab-home-vids" class="tab-btn active whitespace-nowrap">Obras da Home</button>
            <button onclick="switchTab('trabalhos')" id="tab-trabalhos" class="tab-btn whitespace-nowrap">Portfólio</button>
            <button onclick="switchTab('galeria')" id="tab-galeria" class="tab-btn whitespace-nowrap">Galeria de Fotos</button>
            <button onclick="switchTab('identidade')" id="tab-identidade" class="tab-btn whitespace-nowrap">Identidade & SEO</button>
            <button onclick="switchTab('bio')" id="tab-bio" class="tab-btn whitespace-nowrap">Biografia</button>
        </div>

        <!-- ABA GALERIA -->
        <div id="section-galeria" class="hidden grid lg:grid-cols-12 gap-16">
            <div class="lg:col-span-4 space-y-12">
                <section class="bg-neutral-950 p-8 rounded-[2rem] border border-white/5">
                    <h2 class="text-sm font-bold mb-8 uppercase tracking-widest text-neutral-500">Categorias</h2>
                    <form id="cat-form" class="space-y-4 mb-8">
                        <input type="text" id="cat-name" placeholder="Nome da Categoria" class="input-dark text-xs" required>
                        <button type="submit" class="w-full btn-primary py-3">Criar Categoria</button>
                    </form>
                    <div id="admin-cats-list" class="space-y-2">
                        <!-- Categorias dinâmicas -->
                    </div>
                </section>

                <section class="bg-neutral-950 p-8 rounded-[2rem] border border-white/5 sticky top-10">
                    <h2 class="text-sm font-bold mb-8 uppercase tracking-widest text-neutral-500">Subir Foto</h2>
                    <form id="gallery-form" class="space-y-4">
                        <input type="text" id="gal-title" placeholder="Título" class="input-dark text-xs" required>
                        <input type="text" id="gal-year" placeholder="Ano/Período" class="input-dark text-xs">
                        <select id="gal-cat" class="input-dark text-xs" required>
                            <option value="">Selecione a Categoria</option>
                        </select>
                        <textarea id="gal-desc" placeholder="Descrição (SEO)" class="input-dark text-xs" rows="2"></textarea>
                        
                        <div class="space-y-2">
                            <label class="text-[8px] text-neutral-600 uppercase font-bold tracking-widest">Arquivo Original (JPG/PNG)</label>
                            <input type="file" id="gal-file" class="text-[10px] w-full text-neutral-500" accept="image/*" required>
                        </div>

                        <div id="upload-status" class="hidden">
                            <p id="status-text" class="text-[9px] uppercase font-bold text-blue-400">Processando WebP...</p>
                            <div class="progress-bar"><div id="progress-val" class="progress-inner"></div></div>
                        </div>

                        <button type="submit" id="gal-submit-btn" class="w-full btn-primary">Adicionar à Galeria</button>
                    </form>
                </section>
            </div>
            <div class="lg:col-span-8">
                <div id="admin-gallery-list" class="space-y-3">
                    <!-- Lista de fotos -->
                </div>
            </div>
        </div>

        <!-- OUTRAS ABAS (Mantidas conforme original) -->
        <div id="section-home-vids" class="grid lg:grid-cols-12 gap-16">
            <div class="lg:col-span-4">
                <section class="bg-neutral-950 p-8 rounded-[2rem] border border-white/5 sticky top-10">
                    <h2 class="text-sm font-bold mb-8 uppercase tracking-widest text-neutral-500">Destaque na Inicial</h2>
                    <form id="home-vid-form" class="space-y-4">
                        <input type="hidden" id="home-vid-id">
                        <input type="text" id="home-vid-title" placeholder="Título da Obra" class="input-dark text-xs" required>
                        <input type="url" id="home-vid-url" placeholder="Link YouTube" class="input-dark text-xs" required>
                        <button type="submit" id="home-vid-submit-btn" class="w-full btn-primary">Salvar na Home</button>
                        <button type="button" id="cancel-home-edit-btn" onclick="resetHomeVidEditor()" class="hidden w-full bg-neutral-800 p-4 rounded-xl text-[10px] font-bold uppercase tracking-widest mt-2">Cancelar Edição</button>
                    </form>
                </section>
            </div>
            <div class="lg:col-span-8"><div id="admin-home-vids-list" class="space-y-3"></div></div>
        </div>

        <div id="section-trabalhos" class="hidden grid lg:grid-cols-12 gap-16">
            <div class="lg:col-span-4">
                <section class="bg-neutral-950 p-8 rounded-[2rem] border border-white/5 sticky top-10">
                    <h2 id="editor-title" class="text-sm font-bold mb-8 uppercase tracking-widest text-neutral-500">Novo Projeto</h2>
                    <form id="work-form" class="space-y-4">
                        <input type="hidden" id="work-id">
                        <input type="text" id="work-title" placeholder="Título" class="input-dark text-xs" required>
                        <input type="text" id="work-date" placeholder="Ano" class="input-dark text-xs">
                        <input type="url" id="work-video-url" placeholder="Link YouTube" class="input-dark text-xs">
                        <textarea id="work-desc" rows="4" placeholder="Descrição técnica..." class="input-dark text-xs"></textarea>
                        <input type="file" id="work-file" class="text-[10px] w-full text-neutral-500">
                        <button type="submit" id="work-submit-btn" class="w-full btn-primary">Publicar</button>
                    </form>
                </section>
            </div>
            <div class="lg:col-span-8"><div id="admin-works-list" class="space-y-3"></div></div>
        </div>

        <div id="section-identidade" class="hidden max-w-2xl mx-auto">
            <div class="bg-neutral-950 p-12 rounded-[3rem] border border-white/5">
                <h2 class="text-lg font-bold mb-10 italic">Marca & Google</h2>
                <form id="settings-form" class="space-y-6">
                    <textarea id="set-slogan" rows="3" class="input-dark text-sm" placeholder="Slogan..."></textarea>
                    <textarea id="set-seo-desc" rows="3" class="input-dark text-sm" placeholder="SEO..."></textarea>
                    <textarea id="set-footer" rows="5" class="input-dark text-sm" placeholder="Rodapé..."></textarea>
                    <button type="submit" class="w-full btn-primary">Sincronizar</button>
                </form>
            </div>
        </div>

        <div id="section-bio" class="hidden max-w-3xl mx-auto">
            <div class="bg-neutral-950 p-12 rounded-[3rem] border border-white/5">
                <h2 class="text-lg font-bold mb-10 italic">Sua História</h2>
                <form id="bio-form" class="space-y-6">
                    <textarea id="admin-bio-text" rows="15" class="input-dark text-sm" placeholder="Biografia..."></textarea>
                    <button type="submit" class="w-full btn-primary">Salvar Biografia</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, getDoc, updateDoc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDhSp-QPDZI2AbNrYdZO447NKTF2PMYjlQ",
          authDomain: "humano-studio.firebaseapp.com",
          projectId: "humano-studio",
          storageBucket: "humano-studio.firebasestorage.app",
          messagingSenderId: "938534325822",
          appId: "1:938534325822:web:abf5443336ce3224190b6f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        onAuthStateChanged(auth, (user) => {
            if(user){
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                init();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            }
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value)
                .catch(() => alert('Acesso restrito.'));
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        window.switchTab = (tab) => {
            ['trabalhos', 'identidade', 'bio', 'home-vids', 'galeria'].forEach(t => {
                const section = document.getElementById('section-' + t);
                const tabBtn = document.getElementById('tab-' + t);
                if(section) section.classList.add('hidden');
                if(tabBtn) tabBtn.classList.remove('active');
            });
            document.getElementById('section-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active');
        };

        function init() {
            loadHomeVids();
            loadWorks();
            loadSettings();
            loadBio();
            loadGalleryCategories();
            loadGalleryPhotos();
            initSortable();
        }

        // --- GALERIA: CATEGORIAS ---
        function loadGalleryCategories() {
            onSnapshot(collection(db, "galeria_categorias"), (snap) => {
                const list = document.getElementById('admin-cats-list');
                const select = document.getElementById('gal-cat');
                list.innerHTML = '';
                select.innerHTML = '<option value="">Selecione a Categoria</option>';
                
                let cats = [];
                snap.forEach(d => cats.push({id: d.id, ...d.data()}));
                cats.sort((a,b) => (a.ordem ?? 0) - (b.ordem ?? 0));
                
                cats.forEach(cat => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-neutral-900 p-3 rounded-xl border border-white/5">
                            <span class="text-[10px] font-bold uppercase tracking-widest">${cat.nome}</span>
                            <button onclick="deleteCategory('${cat.id}')" class="text-[9px] text-neutral-600 hover:text-red-500 uppercase font-bold">Excluir</button>
                        </div>
                    `;
                    select.innerHTML += `<option value="${cat.slug}">${cat.nome}</option>`;
                });
            });
        }

        document.getElementById('cat-form').onsubmit = async (e) => {
            e.preventDefault();
            const nome = document.getElementById('cat-name').value;
            const slug = nome.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-');
            await addDoc(collection(db, "galeria_categorias"), { nome, slug, ordem: Date.now() });
            e.target.reset();
        };

        window.deleteCategory = (id) => confirm('Excluir esta categoria?') && deleteDoc(doc(db, "galeria_categorias", id));

        // --- GALERIA: FOTOS & CONVERSÃO WEB P ---
        async function processImageToWebP(file, maxWidth, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/webp', quality);
                    };
                };
            });
        }

        document.getElementById('gallery-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('gal-submit-btn');
            const statusBox = document.getElementById('upload-status');
            const progressVal = document.getElementById('progress-val');
            const statusText = document.getElementById('status-text');
            const file = document.getElementById('gal-file').files[0];
            
            if (!file) return;

            btn.disabled = true;
            statusBox.classList.remove('hidden');
            progressVal.style.width = '10%';
            
            try {
                // Conversão Client-side (Substitui o sharp/Node.js em ambiente estático)
                statusText.innerText = "Gerando WebP Full (1920px)...";
                const fullBlob = await processImageToWebP(file, 1920, 0.82);
                progressVal.style.width = '30%';

                statusText.innerText = "Gerando WebP Médio (1024px)...";
                const medBlob = await processImageToWebP(file, 1024, 0.80);
                progressVal.style.width = '50%';

                statusText.innerText = "Gerando Thumbnail (400px)...";
                const thumbBlob = await processImageToWebP(file, 400, 0.75);
                progressVal.style.width = '70%';

                // Upload
                statusText.innerText = "Enviando arquivos...";
                const timestamp = Date.now();
                
                const upload = async (blob, name) => {
                    const r = ref(storage, `galeria/${timestamp}_${name}.webp`);
                    await uploadBytes(r, blob);
                    return await getDownloadURL(r);
                };

                const [fullUrl, medUrl, thumbUrl] = await Promise.all([
                    upload(fullBlob, 'full'),
                    upload(medBlob, 'medium'),
                    upload(thumbBlob, 'thumb')
                ]);

                await addDoc(collection(db, "galeria_fotos"), {
                    titulo: document.getElementById('gal-title').value,
                    ano: document.getElementById('gal-year').value,
                    categoria: document.getElementById('gal-cat').value,
                    descricao: document.getElementById('gal-desc').value,
                    fullWebp: fullUrl,
                    mediumWebp: medUrl,
                    thumbWebp: thumbUrl,
                    ordem: Date.now(),
                    createdAt: serverTimestamp()
                });

                progressVal.style.width = '100%';
                statusText.innerText = "Concluído!";
                setTimeout(() => {
                    statusBox.classList.add('hidden');
                    e.target.reset();
                    btn.disabled = false;
                }, 2000);

            } catch (err) {
                console.error(err);
                alert("Erro no processamento.");
                btn.disabled = false;
            }
        };

        function loadGalleryPhotos() {
            onSnapshot(collection(db, "galeria_fotos"), (snap) => {
                const list = document.getElementById('admin-gallery-list');
                let photos = [];
                snap.forEach(d => photos.push({id: d.id, ...d.data()}));
                photos.sort((a,b) => (a.ordem ?? 0) - (b.ordem ?? 0));
                list.innerHTML = '';
                
                photos.forEach(p => {
                    list.innerHTML += `
                        <div data-id="${p.id}" class="bg-neutral-900/40 p-4 rounded-2xl border border-white/5 flex items-center gap-4 group">
                            <div class="drag-handle-gal cursor-grab opacity-20 font-mono">:::</div>
                            <img src="${p.thumbWebp}" class="w-16 h-16 object-cover rounded-lg grayscale group-hover:grayscale-0">
                            <div class="flex-1">
                                <h4 class="text-[10px] font-bold uppercase tracking-widest">${p.titulo}</h4>
                                <p class="text-[8px] text-neutral-600 uppercase font-bold">${p.categoria} | ${p.ano || '---'}</p>
                            </div>
                            <button onclick="deletePhoto('${p.id}')" class="text-[9px] text-neutral-700 hover:text-red-500 font-bold uppercase">Excluir</button>
                        </div>
                    `;
                });
            });
        }

        window.deletePhoto = (id) => confirm('Remover esta foto da galeria?') && deleteDoc(doc(db, "galeria_fotos", id));

        // --- FUNÇÕES DE CARREGAMENTO ORIGINAIS (Preservadas) ---
        function loadHomeVids(){
            onSnapshot(collection(db, "videos"), (snap) => {
                const list = document.getElementById('admin-home-vids-list');
                let vids = [];
                snap.forEach(d => vids.push({id: d.id, ...d.data()}));
                vids.sort((a,b) => (a.ordem ?? 0) - (b.ordem ?? 0));
                list.innerHTML = '';
                vids.forEach(v => {
                    list.innerHTML += `<div data-id="${v.id}" class="bg-neutral-900/40 p-5 rounded-2xl border border-white/5 flex items-center gap-6">
                        <div class="drag-handle cursor-grab opacity-10 font-mono">:::</div>
                        <div class="flex-1"><h4 class="text-[10px] font-bold uppercase text-white">${v.titulo}</h4></div>
                        <button onclick="deleteHomeVid('${v.id}')" class="text-[9px] text-neutral-700 hover:text-red-500 font-bold">Remover</button>
                    </div>`;
                });
            });
        }
        window.deleteHomeVid = (id) => confirm('Excluir?') && deleteDoc(doc(db, "videos", id));

        function loadWorks(){
            onSnapshot(collection(db, "trabalhos"), (snap) => {
                const list = document.getElementById('admin-works-list');
                let works = [];
                snap.forEach(d => works.push({id: d.id, ...d.data()}));
                works.sort((a,b) => (a.ordem ?? 0) - (b.ordem ?? 0));
                list.innerHTML = '';
                works.forEach(w => {
                    list.innerHTML += `<div data-id="${w.id}" class="bg-neutral-900/40 p-5 rounded-2xl border border-white/5 flex items-center gap-6">
                        <div class="drag-handle-works cursor-grab opacity-10 font-mono">:::</div>
                        <div class="flex-1"><h4 class="text-[10px] font-bold uppercase">${w.titulo}</h4></div>
                        <button onclick="deleteWork('${w.id}')" class="text-[9px] text-neutral-700 hover:text-red-500 font-bold">Remover</button>
                    </div>`;
                });
            });
        }
        window.deleteWork = (id) => confirm('Excluir?') && deleteDoc(doc(db, "trabalhos", id));

        function loadSettings(){
            onSnapshot(doc(db, "site_content", "settings"), (snap) => {
                if(snap.exists()){
                    const d = snap.data();
                    document.getElementById('set-slogan').value = d.slogan || '';
                    document.getElementById('set-seo-desc').value = d.seoDesc || '';
                    document.getElementById('set-footer').value = d.footerAddress || '';
                }
            });
        }
        document.getElementById('settings-form').onsubmit = async (e) => {
            e.preventDefault();
            await setDoc(doc(db, "site_content", "settings"), {
                slogan: document.getElementById('set-slogan').value,
                seoDesc: document.getElementById('set-seo-desc').value,
                footerAddress: document.getElementById('set-footer').value
            }, {merge: true});
            alert('Configurações salvas!');
        };

        function loadBio(){
            onSnapshot(doc(db, "site_content", "bio_page"), (snap) => {
                if(snap.exists()) document.getElementById('admin-bio-text').value = snap.data().bioText || '';
            });
        }
        document.getElementById('bio-form').onsubmit = async (e) => {
            e.preventDefault();
            await setDoc(doc(db, "site_content", "bio_page"), { bioText: document.getElementById('admin-bio-text').value }, {merge: true});
            alert('Bio salva!');
        };

        function initSortable() {
            Sortable.create(document.getElementById('admin-home-vids-list'), {
                animation: 150, handle: '.drag-handle',
                onEnd: async () => {
                    const batch = writeBatch(db);
                    document.querySelectorAll('#admin-home-vids-list > div').forEach((el, i) => batch.update(doc(db, "videos", el.dataset.id), { ordem: i }));
                    await batch.commit();
                }
            });
            Sortable.create(document.getElementById('admin-works-list'), {
                animation: 150, handle: '.drag-handle-works',
                onEnd: async () => {
                    const batch = writeBatch(db);
                    document.querySelectorAll('#admin-works-list > div').forEach((el, i) => batch.update(doc(db, "trabalhos", el.dataset.id), { ordem: i }));
                    await batch.commit();
                }
            });
            Sortable.create(document.getElementById('admin-gallery-list'), {
                animation: 150, handle: '.drag-handle-gal',
                onEnd: async () => {
                    const batch = writeBatch(db);
                    document.querySelectorAll('#admin-gallery-list > div').forEach((el, i) => batch.update(doc(db, "galeria_fotos", el.dataset.id), { ordem: i }));
                    await batch.commit();
                }
            });
        }
    </script>
</body>
</html>
