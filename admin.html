
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cérebro | Fabio Benedetti Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background-color: #080808; color: white; font-family: 'Inter', sans-serif; }
        .input-dark { background: #121212; border: 1px solid #222; padding: 16px; border-radius: 12px; width: 100%; color: white; outline: none; transition: all 0.3s; }
        .input-dark:focus { border-color: #444; background: #181818; }
        .btn-primary { background: white; color: black; font-weight: bold; padding: 16px; border-radius: 12px; transition: all 0.3s; cursor: pointer; text-transform: uppercase; letter-spacing: 0.1em; font-size: 11px; }
        .btn-primary:hover { background: #eee; transform: translateY(-2px); }
        .tab-btn { color: #444; transition: all 0.3s; padding: 12px 0; font-size: 10px; font-weight: bold; letter-spacing: 0.25em; border-bottom: 2px solid transparent; text-transform: uppercase; }
        .tab-btn.active { color: white; border-color: white; }
        .hidden { display: none; }
        
        /* Estilo para o texto de referência */
        .live-reference { 
            background: rgba(255,255,255,0.02); 
            border-left: 2px solid #333; 
            padding: 12px 16px; 
            margin-bottom: 12px; 
            font-size: 11px; 
            color: #666; 
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="p-6 md:p-12">

    <div id="login-screen" class="max-w-md mx-auto mt-24 p-12 bg-neutral-900/50 rounded-[3rem] border border-white/5 backdrop-blur-xl">
        <h1 class="text-2xl font-bold mb-10 text-center tracking-tighter italic">FABIO <span class="text-neutral-600 font-light">Cérebro</span></h1>
        <form id="login-form" class="space-y-4">
            <input type="email" id="login-email" placeholder="E-mail" class="input-dark" required>
            <input type="password" id="login-pass" placeholder="Senha" class="input-dark" required>
            <button type="submit" class="w-full btn-primary">Entrar</button>
        </form>
    </div>

    <div id="admin-dashboard" class="max-w-6xl mx-auto hidden">
        <div class="flex justify-between items-center mb-16 border-b border-white/5 pb-10">
            <h1 class="text-xs font-bold tracking-[0.5em] uppercase">Controle de Sistema <span class="text-neutral-700 italic lowercase ml-2">fabiobenedetti.com.br</span></h1>
            <button id="logout-btn" class="text-[9px] text-neutral-600 hover:text-red-500 uppercase tracking-widest font-bold">Encerrar Sessão</button>
        </div>

        <div class="flex space-x-12 mb-20 border-b border-white/5">
            <button onclick="switchTab('trabalhos')" id="tab-trabalhos" class="tab-btn active">Portfólio</button>
            <button onclick="switchTab('identidade')" id="tab-identidade">Identidade & SEO</button>
            <button onclick="switchTab('bio')" id="tab-bio">Biografia</button>
        </div>

        <!-- ABA TRABALHOS -->
        <div id="section-trabalhos" class="grid lg:grid-cols-12 gap-16">
            <div class="lg:col-span-4">
                <section class="bg-neutral-950 p-8 rounded-[2rem] border border-white/5 sticky top-10">
                    <h2 id="editor-title" class="text-sm font-bold mb-8 uppercase tracking-widest text-neutral-500">Novo Projeto</h2>
                    <form id="work-form" class="space-y-4">
                        <input type="hidden" id="work-id">
                        <input type="text" id="work-title" placeholder="Título" class="input-dark text-xs" required>
                        <input type="text" id="work-date" placeholder="Ano" class="input-dark text-xs">
                        <input type="url" id="work-video-url" placeholder="Link YouTube" class="input-dark text-xs">
                        <textarea id="work-desc" rows="4" placeholder="Descrição técnica..." class="input-dark text-xs"></textarea>
                        
                        <div class="space-y-2">
                            <label class="text-[8px] text-neutral-600 uppercase font-bold tracking-widest">Foto de Capa</label>
                            <input type="file" id="work-file" class="text-[10px] w-full text-neutral-500">
                        </div>

                        <div class="pt-6 flex gap-3">
                            <button type="submit" id="work-submit-btn" class="flex-1 btn-primary">Publicar</button>
                            <button type="button" id="cancel-edit-btn" onclick="resetWorkEditor()" class="hidden bg-neutral-800 px-6 rounded-xl text-xs">X</button>
                        </div>
                    </form>
                </section>
            </div>
            
            <div class="lg:col-span-8">
                <div id="admin-works-list" class="space-y-3">
                    <!-- Lista dinâmica -->
                </div>
            </div>
        </div>

        <!-- ABA IDENTIDADE -->
        <div id="section-identidade" class="hidden max-w-2xl mx-auto">
            <div class="bg-neutral-950 p-12 rounded-[3rem] border border-white/5">
                <h2 class="text-lg font-bold mb-10 italic">Marca & Google</h2>
                <form id="settings-form" class="space-y-6">
                    <div>
                        <label class="block text-[9px] text-neutral-400 mb-1 uppercase font-bold tracking-widest">Slogan Principal Atual:</label>
                        <div id="ref-slogan" class="live-reference">Carregando...</div>
                        <label class="block text-[8px] text-neutral-700 mb-2 uppercase font-medium">Novo texto para o Slogan:</label>
                        <textarea id="set-slogan" rows="3" class="input-dark text-sm" placeholder="Escreva o novo slogan aqui..."></textarea>
                    </div>
                    <div>
                        <label class="block text-[9px] text-neutral-400 mb-1 uppercase font-bold tracking-widest">SEO Atual (Google):</label>
                        <div id="ref-seo" class="live-reference">Carregando...</div>
                        <label class="block text-[8px] text-neutral-700 mb-2 uppercase font-medium">Nova descrição SEO:</label>
                        <textarea id="set-seo-desc" rows="3" class="input-dark text-sm" placeholder="Escreva a nova descrição para o Google..."></textarea>
                    </div>
                    <div>
                        <label class="block text-[9px] text-neutral-400 mb-1 uppercase font-bold tracking-widest">Rodapé Atual:</label>
                        <div id="ref-footer" class="live-reference">Carregando...</div>
                        <label class="block text-[8px] text-neutral-700 mb-2 uppercase font-medium">Novo texto para o rodapé:</label>
                        <textarea id="set-footer" rows="5" class="input-dark text-sm" placeholder="Escreva o novo endereço/rodapé..."></textarea>
                    </div>
                    <button type="submit" class="w-full btn-primary mt-6">Sincronizar com o Site</button>
                </form>
            </div>
        </div>

        <!-- ABA BIO -->
        <div id="section-bio" class="hidden max-w-3xl mx-auto">
            <div class="bg-neutral-950 p-12 rounded-[3rem] border border-white/5">
                <h2 class="text-lg font-bold mb-10 italic">Sua História</h2>
                <form id="bio-form" class="space-y-6">
                    <label class="block text-[9px] text-neutral-400 mb-1 uppercase font-bold tracking-widest">Biografia Atual:</label>
                    <div id="ref-bio" class="live-reference">Carregando...</div>
                    <label class="block text-[8px] text-neutral-700 mb-2 uppercase font-medium">Editar Biografia:</label>
                    <textarea id="admin-bio-text" rows="15" class="input-dark text-sm" placeholder="Sua biografia completa aqui..."></textarea>
                    <button type="submit" class="w-full btn-primary">Salvar Biografia</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp, getDoc, updateDoc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDhSp-QPDZI2AbNrYdZO447NKTF2PMYjlQ",
          authDomain: "humano-studio.firebaseapp.com",
          projectId: "humano-studio",
          storageBucket: "humano-studio.firebasestorage.app",
          messagingSenderId: "938534325822",
          appId: "1:938534325822:web:abf5443336ce3224190b6f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentEditingId = null;

        onAuthStateChanged(auth, (user) => {
            if(user){
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                init();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
            }
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value)
                .catch(() => alert('Acesso restrito ao Produtor.'));
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        window.switchTab = (tab) => {
            ['trabalhos', 'identidade', 'bio'].forEach(t => {
                document.getElementById('section-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('active');
            });
            document.getElementById('section-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('active');
            
            // Recarregar dados ao trocar de aba para garantir visualização do conteúdo atual
            if(tab === 'identidade') loadSettings();
            if(tab === 'bio') loadBio();
        };

        function init(){
            loadWorks();
            loadSettings();
            loadBio();
            initSortable();
        }

        function loadWorks(){
            onSnapshot(collection(db, "trabalhos"), (snap) => {
                const list = document.getElementById('admin-works-list');
                let works = [];
                snap.forEach(d => works.push({id: d.id, ...d.data()}));
                works.sort((a,b) => (a.ordem ?? 0) - (b.ordem ?? 0));
                list.innerHTML = '';
                works.forEach(w => {
                    list.innerHTML += `
                        <div data-id="${w.id}" class="bg-neutral-900/40 p-5 rounded-2xl border border-white/5 flex items-center gap-6 group">
                            <div class="drag-handle cursor-grab opacity-10 group-hover:opacity-40 font-mono">:::</div>
                            <img src="${w.fotoUrl}" class="w-14 h-14 object-cover rounded-xl grayscale group-hover:grayscale-0 transition-all">
                            <div class="flex-1">
                                <h4 class="text-[10px] font-bold uppercase tracking-widest">${w.titulo}</h4>
                                <p class="text-[9px] text-neutral-600 mt-1">${w.data || ''}</p>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="prepareEdit('${w.id}')" class="text-[9px] text-neutral-400 hover:text-white font-bold uppercase tracking-widest">Editar</button>
                                <button onclick="deleteWork('${w.id}')" class="text-[9px] text-neutral-700 hover:text-red-500 font-bold uppercase tracking-widest">Remover</button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        window.prepareEdit = async (id) => {
            const snap = await getDoc(doc(db, "trabalhos", id));
            const data = snap.data();
            currentEditingId = id;
            document.getElementById('work-title').value = data.titulo;
            document.getElementById('work-date').value = data.data || '';
            document.getElementById('work-desc').value = data.descricao || '';
            document.getElementById('work-video-url').value = data.videoUrl || '';
            document.getElementById('editor-title').innerText = "Editando Registro";
            document.getElementById('work-submit-btn').innerText = "Atualizar";
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.resetWorkEditor = () => {
            currentEditingId = null;
            document.getElementById('work-form').reset();
            document.getElementById('editor-title').innerText = "Novo Projeto";
            document.getElementById('work-submit-btn').innerText = "Publicar";
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        };

        document.getElementById('work-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('work-submit-btn');
            btn.disabled = true; btn.innerText = "Sincronizando...";
            const file = document.getElementById('work-file').files[0];
            let payload = {
                titulo: document.getElementById('work-title').value,
                data: document.getElementById('work-date').value,
                descricao: document.getElementById('work-desc').value,
                videoUrl: document.getElementById('work-video-url').value,
                updatedAt: serverTimestamp()
            };
            if(file){
                const refS = ref(storage, `trabalhos/${Date.now()}`);
                await uploadBytes(refS, file);
                payload.fotoUrl = await getDownloadURL(refS);
            }
            if(currentEditingId) await updateDoc(doc(db, "trabalhos", currentEditingId), payload);
            else {
                payload.ordem = Date.now();
                await addDoc(collection(db, "trabalhos"), payload);
            }
            resetWorkEditor();
            btn.disabled = false; btn.innerText = "Publicar";
        };

        window.deleteWork = (id) => confirm('Deseja excluir este trabalho do portfólio?') && deleteDoc(doc(db, "trabalhos", id));

        async function loadSettings(){
            const snap = await getDoc(doc(db, "site_content", "settings"));
            if(snap.exists()){
                const d = snap.data();
                // Preenche Referência Visual (Conteúdo Atual)
                document.getElementById('ref-slogan').innerText = d.slogan || '(Vazio)';
                document.getElementById('ref-seo').innerText = d.seoDesc || '(Vazio)';
                document.getElementById('ref-footer').innerText = d.footerAddress || '(Vazio)';
                
                // Preenche os campos de edição para facilitar a alteração
                document.getElementById('set-slogan').value = d.slogan || '';
                document.getElementById('set-seo-desc').value = d.seoDesc || '';
                document.getElementById('set-footer').value = d.footerAddress || '';
            }
        }

        document.getElementById('settings-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.submitter;
            btn.disabled = true; btn.innerText = "Atualizando...";
            
            await setDoc(doc(db, "site_content", "settings"), {
                slogan: document.getElementById('set-slogan').value,
                seoDesc: document.getElementById('set-seo-desc').value,
                footerAddress: document.getElementById('set-footer').value
            }, {merge: true});
            
            await loadSettings(); // Recarrega referências
            btn.disabled = false; btn.innerText = "Sincronizar com o Site";
            alert('Identidade atualizada no servidor!');
        };

        async function loadBio(){
            const snap = await getDoc(doc(db, "site_content", "bio_page"));
            if(snap.exists()) {
                const text = snap.data().bioText || '';
                document.getElementById('ref-bio').innerText = text || '(Vazio)';
                document.getElementById('admin-bio-text').value = text;
            }
        }
        document.getElementById('bio-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.submitter;
            btn.disabled = true; btn.innerText = "Salvando...";
            
            await setDoc(doc(db, "site_content", "bio_page"), { bioText: document.getElementById('admin-bio-text').value }, {merge: true});
            
            await loadBio(); // Recarrega referência
            btn.disabled = false; btn.innerText = "Salvar Biografia";
            alert('Biografia atualizada!');
        };

        function initSortable() {
            Sortable.create(document.getElementById('admin-works-list'), {
                animation: 150, handle: '.drag-handle',
                onEnd: async () => {
                    const batch = writeBatch(db);
                    document.querySelectorAll('#admin-works-list > div').forEach((el, i) => {
                        batch.update(doc(db, "trabalhos", el.dataset.id), { ordem: i });
                    });
                    await batch.commit();
                }
            });
        }
    </script>
</body>
</html>
